<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inspector Photo Capture v2 Full</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    video, canvas { width: 100%; border-radius: 8px; margin-top: 10px; }
    button { padding: 10px 20px; margin: 6px; font-size: 16px; }
    #controls, #status, #preview { margin-top: 20px; }
    .thumb { width: 80px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
  </style>
</head>
<body>
  <h2>Inspector Step-by-Step Photo Tool</h2>

  <label><strong>Enter Vehicle Plate Number:</strong></label><br>
  <input type="text" id="vehicleId" placeholder="e.g., ABC123" required><br><br>

  <label><strong>Enter Odometer (km):</strong></label><br>
  <input type="text" id="odometerReading" placeholder="e.g., 123456" required><br><br>

  <p id="instruction"></p>

  <video id="camera" autoplay playsinline></video>

  <div id="controls"></div>
  <canvas id="snapshot" style="display:none;"></canvas>
  <div id="status"></div>
  <div id="preview"></div>
<div style="margin-top: 30px;">
  <button onclick="generatePhotoRecord()">üìÅ Generate Photo Record JSON</button>
</div>

<script>
    const singleSteps = [
      // Exterior (21 fixed)
      "exterior_bonnet", "exterior_roof", "exterior_boot",
      "exterior_front_bumper", "exterior_rear_bumper",
      "exterior_left_front_door", "exterior_right_front_door",
      "exterior_left_rear_door", "exterior_right_rear_door",
      "exterior_left_fender", "exterior_right_fender",
      "exterior_left_quarter_panel", "exterior_right_quarter_panel",
      "exterior_apillar_left", "exterior_apillar_right",
      "exterior_bpillar_left", "exterior_bpillar_right",
      "exterior_cpillar_left", "exterior_cpillar_right",
      "exterior_front_crash_bar", "exterior_rear_crash_bar",

      // Wheels (8 fixed)
      "pf_tyre", "pf_rim", "pr_tyre", "pr_rim", "df_tyre", "df_rim", "dr_tyre", "dr_rim",

      // Odometer fixed (2)
      "odometer", "transmission_km"
    ];

    const multiSteps = [
  "logbook", "interior", "attachments", "mechanical", "modifications"
];

    let currentStepIndex = 0;
    let inMultiMode = false;
    let multiStepName = "";
    let multiCount = 1;

    const video = document.getElementById("camera");
    const canvas = document.getElementById("snapshot");
    const status = document.getElementById("status");
    const instruction = document.getElementById("instruction");
    const controls = document.getElementById("controls");
    const preview = document.getElementById("preview");

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => video.srcObject = stream)
      .catch(err => alert("Camera access denied: " + err));

    function getVehicleId() {
      return document.getElementById("vehicleId").value.trim().replace(/\s+/g, "_");
    }

    function updateInstruction() {
      preview.innerHTML = "";
      if (!inMultiMode) {
        if (currentStepIndex >= singleSteps.length) {
          enterNextMulti();
          return;
        }
        const name = singleSteps[currentStepIndex];
        instruction.innerHTML = `Step ${currentStepIndex + 1}: Take photo of <strong>${name.replace(/_/g, ' ')}</strong>`;
        controls.innerHTML = `
          <button onclick="takeSinglePhoto()">üì∑ Capture</button>
          <button onclick="markNotEquipped()">üö´ Not Equipped</button>
          <button onclick="markNotAccessible()">‚ùå Not Accessible</button>
        `;
      } else {
        instruction.innerHTML = `Take photos of <strong>${multiStepName}</strong> - current: ${multiCount}`;
        controls.innerHTML = `
          <button onclick="takeMultiPhoto()">üì∑ Take Photo</button>
          <button onclick="endMultiMode()">‚úÖ Finish ${multiStepName}</button>
        `;
      }
    }

    function takeSinglePhoto() {
  const id = getVehicleId();
  if (!id) return alert("Enter vehicle plate number first.");
  const name = singleSteps[currentStepIndex];
  captureAndSave(`${id}_${name}.jpg`);
  currentStepIndex++;
  updateInstruction();
}
}


}

// ‚úÖ Generate photo list JSON file
function generatePhotoRecord() {
  const id = getVehicleId();
  if (!id) return alert("Enter vehicle plate number first.");

  const thumbs = document.querySelectorAll('.thumb');
  const photoList = Array.from(thumbs).map(img => img.title);

  const odo = document.getElementById("odometerReading").value.trim();
  const record = {
    plate: id,
    odometer_km: odo,
    total_photos: photoList.length,
    photos: photoList,
    timestamp: new Date().toISOString()
  };

  const blob = new Blob([JSON.stringify(record, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${id}_photo_record.json`;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => URL.revokeObjectURL(a.href), 100);
  document.body.removeChild(a);
  status.innerText = `‚úÖ JSON Record Saved: ${id}_photo_record.json`;
}
}


    }

    function markNotEquipped() {
      status.innerText = `üö´ Marked Not Equipped: ${singleSteps[currentStepIndex]}`;
      currentStepIndex++;
      updateInstruction();
    }

    function markNotAccessible() {
      status.innerText = `‚ùå Marked Not Accessible: ${singleSteps[currentStepIndex]}`;
      currentStepIndex++;
      updateInstruction();
    }

    function enterNextMulti() {
      if (multiSteps.length === 0) {
        instruction.innerHTML = "‚úÖ All steps completed.";
        controls.innerHTML = "";
        return;
      }
      multiStepName = multiSteps.shift();
      inMultiMode = true;
      multiCount = 1;
      updateInstruction();
    }

    function takeMultiPhoto() {
      const id = getVehicleId();
      if (!id) return alert("Enter vehicle plate number first.");
      const filename = `${id}_${multiStepName}${multiCount}.jpg`;
      captureAndSave(filename);
      multiCount++;
      updateInstruction();
    }

    function endMultiMode() {
      inMultiMode = false;
      updateInstruction();
    }

    function captureAndSave(filename) {
      canvas.style.display = "block";
      const ctx = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        status.innerText = `‚úÖ Saved: ${filename}`;
        showThumbnail(blob, filename);
      }, 'image/jpeg');
    }

    function showThumbnail(blob, name) {
      const img = document.createElement("img");
      img.src = URL.createObjectURL(blob);
      img.className = "thumb";
      img.title = name;
      preview.appendChild(img);
    }

    window.onload = updateInstruction;
  </script>
</body>
</html>
